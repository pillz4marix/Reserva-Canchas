<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGP Admin - Panel de Control</title>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #050505; 
            --card: #121212; 
            --border: #222222;
            --text-p: #ffffff; 
            --text-s: #a1a1aa; 
            --accent: #fbbf24; 
            --error: #ef4444; 
            --success: #22c55e;
            --glass: rgba(255, 255, 255, 0.03);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', -apple-system, sans-serif; }
        body { background: var(--bg); color: var(--text-p); min-height: 100vh; }
        
        .container { width: 100%; max-width: 550px; margin: 0 auto; padding: 25px; }

        .login-box { 
            background: var(--card); 
            padding: 40px; 
            border-radius: 24px; 
            border: 1px solid var(--border); 
            margin-top: 80px; 
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        
        .login-box h2 { letter-spacing: 4px; font-weight: 300; margin-bottom: 8px; }

        input[type="password"], input[type="date"] { 
            width: 100%; 
            background: #1a1a1a; 
            border: 1px solid var(--border); 
            padding: 16px; 
            color: white; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            outline: none;
            transition: all 0.3s;
        }

        .btn-p { 
            width: 100%; 
            padding: 16px; 
            background: var(--accent); 
            color: black; 
            border: none; 
            font-weight: 800; 
            border-radius: 12px; 
            cursor: pointer; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-admin { 
            padding: 10px 0 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .badge-admin { 
            background: rgba(251, 191, 36, 0.1); 
            color: var(--accent); 
            font-size: 0.65rem; 
            padding: 4px 10px; 
            border-radius: 20px; 
            font-weight: bold;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .stat-card { 
            background: var(--glass); 
            border: 1px solid var(--border); 
            padding: 20px; 
            border-radius: 20px; 
            backdrop-filter: blur(10px);
        }
        .stat-card small { color: var(--text-s); font-size: 0.7rem; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .stat-card p { font-size: 1.8rem; font-weight: 300; color: white; }

        .date-nav-container { display: flex; align-items: center; gap: 12px; margin-bottom: 25px; }
        .nav-arrow { 
            background: var(--card); 
            border: 1px solid var(--border); 
            color: white; 
            width: 50px; height: 50px; 
            border-radius: 15px; 
            cursor: pointer; 
        }
        .nav-arrow:disabled { opacity: 0.2; cursor: not-allowed; }

        .slot-group {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .slot-header-time {
            font-size: 0.75rem;
            color: var(--accent);
            font-weight: bold;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #1a1a1a;
        }

        .cancha-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 10px 0;
        }
        .cancha-item:not(:last-child) { border-bottom: 1px solid #1a1a1a; }
        
        .slot-info h4 { font-size: 0.85rem; font-weight: 500; }
        .slot-info p { font-size: 0.75rem; color: var(--text-s); }
        
        .actions { display: flex; gap: 8px; }
        .btn-wa { background: #25d366; color: white; border: none; padding: 0 10px; height: 32px; border-radius: 8px; display: flex; align-items: center; text-decoration: none; font-size: 0.65rem; font-weight: bold; }
        .btn-kick { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: var(--error); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; }
        .btn-block { background: transparent; border: 1px solid var(--border); color: var(--text-s); padding: 0 10px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 0.65rem; font-weight: bold; }
        .btn-liberar { background: var(--accent); color: black; border: none; padding: 0 10px; height: 32px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.65rem; }

        /* Estilo para botones deshabilitados */
        button:disabled { opacity: 0.2 !important; cursor: not-allowed !important; }

        .tab-nav { display: flex; background: #111; padding: 5px; border-radius: 14px; margin-bottom: 25px; border: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-s); border-radius: 10px; cursor: pointer; font-size: 0.85rem; font-weight: 600; }
        .tab-btn.active { background: #1a1a1a; color: white; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div id="admin-login" class="login-box">
        <h2 style="margin-top: 10px;">SGP ADMIN</h2>
        <p style="font-size: 0.85rem; color: var(--text-s); margin-bottom: 25px;">Panel de Gestión Privado</p>
        <input type="password" id="pass-field" placeholder="Clave de acceso" onkeydown="handleLoginEnter(event)">
        <button class="btn-p" onclick="checkPass()">Iniciar Sesión</button>
    </div>

    <div id="admin-panel" class="hidden">
        <div class="header-admin">
            <div>
                <h2 style="font-weight: 400; font-size: 1.3rem;">Dashboard</h2>
                <span class="badge-admin">SISTEMA ACTIVO</span>
            </div>
            <button onclick="location.reload()" style="background:rgba(239, 68, 68, 0.1); border:none; color:var(--error); padding: 8px 15px; border-radius: 10px; font-size:0.7rem; cursor:pointer; font-weight: 800;">SALIR</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><small>Turnos Hoy</small><p id="stat-hoy">0</p></div>
            <div class="stat-card"><small>Usuarios</small><p id="stat-users">0</p></div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" id="tab1" onclick="switchTab('agenda')">Agenda</button>
            <button class="tab-btn" id="tab2" onclick="switchTab('usuarios')">Usuarios</button>
        </div>

        <div id="view-agenda">
            <div class="date-nav-container">
                <button class="nav-arrow" id="btn-prev" onclick="changeDate(-1)">‹</button>
                <input type="date" id="admin-date" onchange="loadAgenda()" style="margin-bottom:0">
                <button class="nav-arrow" onclick="changeDate(1)">›</button>
            </div>
            <div id="admin-schedule-list"></div>
        </div>

        <div id="view-usuarios" class="hidden">
            <div id="admin-users-list"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAEiNdPIcFY-CC3R4YpDrROv_ERC4Pquvw",
        authDomain: "horarios-16943.firebaseapp.com",
        databaseURL: "https://horarios-16943-default-rtdb.firebaseio.com",
        projectId: "horarios-16943",
        storageBucket: "horarios-16943.firebasestorage.app",
        messagingSenderId: "278418928966",
        appId: "1:278418928966:web:695adf6cbeee5dafb42147"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const hours = ["16:00 - 18:00", "18:00 - 20:00"];
    const canchas = ["Cancha 1", "Cancha 2"];

    function handleLoginEnter(event) {
        if (event.key === "Enter") checkPass();
    }

    function checkPass() {
        if(document.getElementById('pass-field').value === "Brio2015") {
            document.getElementById('admin-login').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            initPanel();
        } else { 
            alert("Clave incorrecta."); 
        }
    }

    function initPanel() {
        const hoy = new Date();
        const offset = hoy.getTimezoneOffset();
        const localHoy = new Date(hoy.getTime() - (offset*60*1000)).toISOString().split('T')[0];
        
        const dateInput = document.getElementById('admin-date');
        dateInput.value = localHoy;
        dateInput.min = localHoy;
        
        loadAgenda();
        loadUsers();
    }

    function switchTab(tab) {
        document.getElementById('view-agenda').classList.toggle('hidden', tab !== 'agenda');
        document.getElementById('view-usuarios').classList.toggle('hidden', tab !== 'usuarios');
        document.getElementById('tab1').classList.toggle('active', tab === 'agenda');
        document.getElementById('tab2').classList.toggle('active', tab === 'usuarios');
    }

    function changeDate(days) {
        const input = document.getElementById('admin-date');
        let d = new Date(input.value + 'T00:00:00');
        d.setDate(d.getDate() + days);
        const hoy = new Date();
        hoy.setHours(0,0,0,0);
        if (d < hoy) return;
        input.value = d.toISOString().split('T')[0];
        loadAgenda();
    }

    async function loadAgenda() {
        const dateStr = document.getElementById('admin-date').value;
        const selectedDate = new Date(dateStr + 'T00:00:00');
        const hoy = new Date();
        const currentHour = hoy.getHours();
        hoy.setHours(0,0,0,0);
        
        const isToday = selectedDate.getTime() === hoy.getTime();
        document.getElementById('btn-prev').disabled = isToday;

        db.ref('reservas/' + dateStr).on('value', async snap => {
            const data = snap.val() || {};
            const container = document.getElementById('admin-schedule-list');
            container.innerHTML = '';
            let totalBookings = 0;

            for (const h of hours) {
                const hKey = h.replace(/[:\s]/g, '_');
                const hourStart = parseInt(h.split(':')[0]);
                // Si es hoy y la hora de inicio es igual o menor a la actual, ya pasó
                const isPast = isToday && hourStart <= currentHour;
                
                let groupHtml = `<div class="slot-group"><div class="slot-header-time">${h} ${isPast ? '(PASADO)' : ''}</div>`;

                for (const c of canchas) {
                    const cKey = c.replace(/\s/g, '');
                    const reservation = data[hKey] ? data[hKey][cKey] : null;
                    
                    let innerContent = '';
                    if(reservation === 'BLOQUEADO') {
                        innerContent = `
                            <div class="slot-info"><h4>${c}</h4><p style="color:var(--accent)">BLOQUEADO</p></div>
                            <div class="actions"><button class="btn-liberar" ${isPast ? 'disabled' : ''} onclick="release('${dateStr}','${hKey}','${cKey}')">LIBERAR</button></div>`;
                    } else if(reservation) {
                        totalBookings++;
                        const uKey = reservation.replace(/\./g, '_');
                        const uSnap = await db.ref('usuarios/' + uKey).once('value');
                        const u = uSnap.val() || { nombre: 'Usuario' };
                        innerContent = `
                            <div class="slot-info"><h4>${c}</h4><p>${u.nombre.toUpperCase()} ${u.paterno || ''}</p></div>
                            <div class="actions">
                                ${u.telefono ? `<a href="https://wa.me/${u.telefono.replace(/\s/g,'')}" target="_blank" class="btn-wa">WA</a>` : ''}
                                <button class="btn-kick" ${isPast ? 'disabled' : ''} onclick="release('${dateStr}','${hKey}','${cKey}')">X</button>
                            </div>`;
                    } else {
                        innerContent = `
                            <div class="slot-info"><h4>${c}</h4><p style="color:var(--success)">DISPONIBLE</p></div>
                            <div class="actions"><button class="btn-block" ${isPast ? 'disabled' : ''} onclick="block('${dateStr}','${hKey}','${cKey}')">BLOQUEAR</button></div>`;
                    }
                    groupHtml += `<div class="cancha-item">${innerContent}</div>`;
                }
                groupHtml += `</div>`;
                container.insertAdjacentHTML('beforeend', groupHtml);
            }
            document.getElementById('stat-hoy').innerText = totalBookings;
        });
    }

    function loadUsers() {
        db.ref('usuarios').on('value', snap => {
            const users = snap.val() || {};
            const container = document.getElementById('admin-users-list');
            container.innerHTML = '';
            let count = 0;
            Object.keys(users).forEach(k => {
                count++;
                const u = users[k];
                container.innerHTML += `<div class="slot-group" style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                    <div class="slot-info"><h4>${u.nombre.toUpperCase()}</h4><p>${u.email}</p></div>
                    ${u.telefono ? `<a href="https://wa.me/${u.telefono.replace(/\s/g,'')}" target="_blank" class="btn-wa">MENSAJE</a>` : ''}
                </div>`;
            });
            document.getElementById('stat-users').innerText = count;
        });
    }

    function block(d, hK, cK) { 
        db.ref(`reservas/${d}/${hK}/${cK}`).set('BLOQUEADO'); 
    }

    function release(d, hK, cK) { 
        if(confirm("¿Desea usted liberar este espacio?")) {
            db.ref(`reservas/${d}/${hK}/${cK}`).remove(); 
        }
    }
</script>
</body>
</html>